---
# Source: opencloud/templates/opencloud/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: release-name-opencloud-opencloud
type: Opaque
stringData:
  adminPassword: admin
---
# Source: opencloud/templates/opencloud/config-json-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-opencloud-opencloud-config-json
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: opencloud
data:
  config.json: |-
    {
      "server": "https://opencloud.mcintosh.farm",
      "theme": "owncloud",
      "version": "0.1.0"
    }
---
# Source: opencloud/templates/opencloud/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-opencloud-opencloud-config
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: opencloud
data:
  # App registry configuration
  app-registry.yaml: |-
    app_registry:
      mimetypes:
      - mime_type: application/pdf
        extension: pdf
        name: PDF
        description: PDF document
        icon: ''
        default_app: ''
        allow_creation: false
      - mime_type: application/vnd.oasis.opendocument.text
        extension: odt
        name: OpenDocument
        description: OpenDocument text document
        icon: ''
        default_app: Collabora
        allow_creation: true
      - mime_type: application/vnd.oasis.opendocument.spreadsheet
        extension: ods
        name: OpenSpreadsheet
        description: OpenDocument spreadsheet document
        icon: ''
        default_app: Collabora
        allow_creation: true
      - mime_type: application/vnd.oasis.opendocument.presentation
        extension: odp
        name: OpenPresentation
        description: OpenDocument presentation document
        icon: ''
        default_app: Collabora
        allow_creation: true
      - mime_type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
        extension: docx
        name: Microsoft Word
        description: Microsoft Word document
        icon: ''
        default_app: OnlyOffice
        allow_creation: true
      - mime_type: application/vnd.openxmlformats-officedocument.wordprocessingml.form
        extension: docxf
        name: Form Document
        description: Form Document
        icon: ''
        default_app: OnlyOffice
        allow_creation: true
      - mime_type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
        extension: xlsx
        name: Microsoft Excel
        description: Microsoft Excel document
        icon: ''
        default_app: OnlyOffice
        allow_creation: true
      - mime_type: application/vnd.openxmlformats-officedocument.presentationml.presentation
        extension: pptx
        name: Microsoft PowerPoint
        description: Microsoft PowerPoint document
        icon: ''
        default_app: OnlyOffice
        allow_creation: true
      - mime_type: application/vnd.jupyter
        extension: ipynb
        name: Jupyter Notebook
        description: Jupyter Notebook
        icon: ''
        default_app: ''
        allow_creation: true

  # CSP configuration
  csp.yaml: |-
    directives:
      child-src:
        - '''self'''
      connect-src:
        - '''self'''
        - 'blob:'
        - 'https://companion.mcintosh.farm/'
        - 'wss://companion.mcintosh.farm/'
        - 'https://raw.githubusercontent.com/opencloud-eu/awesome-apps/'
        - 'https://integrator-3395767.okta.com/'
      default-src:
        - '''none'''
      font-src:
        - '''self'''
      frame-ancestors:
        - '''self'''
      frame-src:
        - '''self'''
        - 'blob:'
        - 'https://embed.diagrams.net/'
        # In contrary to bash and docker the default is given after the | character
        - 'https://onlyoffice.mcintosh.farm/'
        - 'https://collabora.mcintosh.farm/'
        # This is needed for the external-sites web extension when embedding sites
        - 'https://docs.opencloud.eu'
      img-src:
        - '''self'''
        - 'data:'
        - 'blob:'
        - 'https://raw.githubusercontent.com/opencloud-eu/awesome-apps/'
        # In contrary to bash and docker the default is given after the | character
        - 'https://onlyoffice.mcintosh.farm/'
        - 'https://collabora.mcintosh.farm/'
      manifest-src:
        - '''self'''
      media-src:
        - '''self'''
      object-src:
        - '''self'''
        - 'blob:'
      script-src:
        - '''self'''
        - '''unsafe-inline'''
      style-src:
        - '''self'''
        - '''unsafe-inline'''
      worker-src:
        - '''self'''
    

  # Banned password list
  banned-password-list.txt: |-
    

  # Search configuration
  search.yaml: |-
    {
      "mapping": {
        "file": {
          "properties": {
            "name": {
              "type": "text",
              "analyzer": "standard"
            },
            "content": {
              "type": "text",
              "analyzer": "standard"
            },
            "mime_type": {
              "type": "keyword"
            },
            "owner": {
              "type": "keyword"
            },
            "path": {
              "type": "text",
              "analyzer": "standard"
            }
          }
        }
      }
    }
---
# Source: opencloud/templates/opencloud/web-extensions-init.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-opencloud-opencloud-web-extensions-init
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: opencloud
data:
  init-web-extensions.sh: |-
    #!/bin/sh
    set -e
    
    # Create apps directory if it doesn't exist
    mkdir -p /var/lib/opencloud/web/assets/apps
    
    # Copy extensions to the apps directory
    echo "Initializing Draw.io extension..."
    cp -R /extensions/draw-io/ /var/lib/opencloud/web/assets/apps/
    echo "Initializing External Sites extension..."
    cp -R /extensions/external-sites/ /var/lib/opencloud/web/assets/apps/
    echo "Initializing Importer extension..."
    cp -R /extensions/importer/ /var/lib/opencloud/web/assets/apps/
    echo "Initializing JSON Viewer extension..."
    cp -R /extensions/json-viewer/ /var/lib/opencloud/web/assets/apps/
    echo "Initializing Progress Bars extension..."
    cp -R /extensions/progress-bars/ /var/lib/opencloud/web/assets/apps/
    echo "Initializing Unzip extension..."
    cp -R /extensions/unzip/ /var/lib/opencloud/web/assets/apps/
    
    echo "Web extensions initialization completed."
---
# Source: opencloud/templates/minio/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: release-name-opencloud-minio-data
  annotations:
    "helm.sh/resource-policy": "keep"
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: minio
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "30Gi"
---
# Source: opencloud/templates/opencloud/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: release-name-opencloud-opencloud-config
  annotations:
    "helm.sh/resource-policy": "keep"
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: opencloud
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "5Gi"
---
# Source: opencloud/templates/opencloud/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: release-name-opencloud-opencloud-data
  annotations:
    "helm.sh/resource-policy": "keep"
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: opencloud
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "30Gi"
---
# Source: opencloud/templates/opencloud/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: release-name-opencloud-opencloud
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: opencloud
spec:
  type: ClusterIP
  ports:
    - port: 9200
      targetPort: http
      protocol: TCP
      name: http
    - port: 9233
      targetPort: 9233
      protocol: TCP
      name: nats
  selector:
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/component: opencloud
---
# Source: opencloud/templates/tika/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: release-name-opencloud-tika
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: tika
spec:
  type: ClusterIP
  ports:
    - port: 9998
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/component: tika
---
# Source: opencloud/templates/opencloud/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: release-name-opencloud-opencloud
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: opencloud
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: opencloud
      app.kubernetes.io/instance: release-name
      app.kubernetes.io/component: opencloud
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: opencloud
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/component: opencloud
      annotations:
        checksum/config-json: aa4ce85d0481423707012cd293e8d10efa433fd294fdcc56134d0f456a22e54a
        checksum/configmap: 2dcf89522370cc034062b77a091079c06ceb2e89c6daad3a18bd2333a4618c91
        checksum/web-extensions-init: 7e42110cff1a64dfb5c8fcf9e7081d866bf96ef2cf7b617bfd524446fc12c22e
    spec:
      securityContext:
        fsGroup: 1000
      initContainers:
        - name: init-config
          image: "docker.io/library/busybox:1.36"
          imagePullPolicy: "IfNotPresent"
          command: ['sh', '-c', 'mkdir -p /etc/opencloud /var/lib/opencloud']
          volumeMounts:
            - name: config
              mountPath: /etc/opencloud
            - name: data
              mountPath: /var/lib/opencloud
        # Web extensions init containers
        - name: init-drawio
          image: "docker.io/opencloudeu/web-extensions:draw-io-1.0.0"
          command: ['sh', '-c', 'mkdir -p /extensions/draw-io && cp -R /usr/share/nginx/html/draw-io/ /extensions/']
          volumeMounts:
            - name: extensions
              mountPath: /extensions
        - name: init-externalsites
          image: "docker.io/opencloudeu/web-extensions:external-sites-1.0.0"
          command: ['sh', '-c', 'mkdir -p /extensions/external-sites && cp -R /usr/share/nginx/html/external-sites/ /extensions/']
          volumeMounts:
            - name: extensions
              mountPath: /extensions
        - name: init-importer
          image: "docker.io/opencloudeu/web-extensions:importer-1.0.0"
          command: ['sh', '-c', 'mkdir -p /extensions/importer && cp -R /usr/share/nginx/html/importer/ /extensions/']
          volumeMounts:
            - name: extensions
              mountPath: /extensions
        - name: init-jsonviewer
          image: "docker.io/opencloudeu/web-extensions:json-viewer-1.0.0"
          command: ['sh', '-c', 'mkdir -p /extensions/json-viewer && cp -R /usr/share/nginx/html/json-viewer/ /extensions/']
          volumeMounts:
            - name: extensions
              mountPath: /extensions
        - name: init-progressbars
          image: "docker.io/opencloudeu/web-extensions:progress-bars-1.0.0"
          command: ['sh', '-c', 'mkdir -p /extensions/progress-bars && cp -R /usr/share/nginx/html/progress-bars/ /extensions/']
          volumeMounts:
            - name: extensions
              mountPath: /extensions
        - name: init-unzip
          image: "docker.io/opencloudeu/web-extensions:unzip-1.0.0"
          command: ['sh', '-c', 'mkdir -p /extensions/unzip && cp -R /usr/share/nginx/html/unzip/ /extensions/']
          volumeMounts:
            - name: extensions
              mountPath: /extensions
        # Final init container to copy all extensions to the apps directory
        - name: init-web-extensions
          image: "docker.io/library/busybox:1.36"
          imagePullPolicy: "IfNotPresent"
          command: ['sh', '/scripts/init-web-extensions.sh']
          volumeMounts:
            - name: extensions
              mountPath: /extensions
            - name: data
              mountPath: /var/lib/opencloud
            - name: web-extensions-init-script
              mountPath: /scripts
      containers:
        - name: opencloud
          image: "docker.io/opencloudeu/opencloud-rolling:2.1.0"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh"]
          args: ["-c", "opencloud init || true; opencloud server"]
          env:
            # OpenCloud URL
            - name: OC_URL
              value: "https://opencloud.mcintosh.farm"
            # Available roles
            - name: GRAPH_AVAILABLE_ROLES
              value: "b1e2218d-eef8-4d4c-b82d-0f1a1b48f3b5,a8d5fe5e-96e3-418d-825b-534dbdf22b99,fb6c3e19-e378-47e5-b277-9732f9de6e21,58c63c02-1d89-4572-916a-870abc5a1b7d,2d00ce52-1fc2-4dbc-8b95-a73b73395f5a,1c996275-f1c9-4e71-abdf-a42f6495e960,312c0871-5ef7-4b3a-85b6-0e4074c64049,aa97fe03-7980-45ac-9e50-b325749fd7e6"
            # Log settings
            - name: OC_LOG_LEVEL
              value: "info"
            - name: OC_LOG_COLOR
              value: "false"
            - name: OC_LOG_PRETTY
              value: "false"
            # Enable services that are not started automatically
            - name: OC_EXCLUDE_RUN_SERVICES
              value: "idp"
            # Do not use SSL between proxy and OpenCloud
            - name: PROXY_TLS
              value: "false"
            # Make the REVA gateway accessible to the app drivers
            - name: GATEWAY_GRPC_ADDR
              value: "0.0.0.0:9142"
            # INSECURE: needed if OpenCloud is using self generated certificates
            - name: OC_INSECURE
              value: "true"
            # Basic auth (only needed when not using Keycloak)
            - name: PROXY_ENABLE_BASIC_AUTH
              value: "false"
            # These vars are needed to the csp config file to include the web office apps and the importer
            - name: ONLYOFFICE_DOMAIN
              value: "onlyoffice.mcintosh.farm"
            - name: COMPANION_DOMAIN
              value: "companion.mcintosh.farm"
            # Sharing settings
            - name: OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD
              value: "false"
            - name: OC_PASSWORD_POLICY_BANNED_PASSWORDS_LIST
              value: "banned-password-list.txt"
            # Search settings
            - name: SEARCH_EXTRACTOR_TYPE
              value: "tika"
            - name: SEARCH_EXTRACTOR_TIKA_TIKA_URL
              value: "http://release-name-opencloud-tika:9998"
            # Performance settings
            - name: OC_GRPC_MAX_RECEIVED_MESSAGE_SIZE
              value: "102400000"
            # Email server (if configured)
            # IDP specific configuration
            - name: PROXY_AUTOPROVISION_ACCOUNTS
              value: "true"
            # user properties are edited in the idp, so we have to make them readonly
            - name: FRONTEND_READONLY_USER_ATTRIBUTES
              value: "user.onPremisesSamAccountName,user.displayName,user.mail,user.passwordProfile,user.accountEnabled,user.appRoleAssignments"
            - name: PROXY_ROLE_ASSIGNMENT_DRIVER
              value: "oidc"
            - name: OC_OIDC_ISSUER
              value: "https://integrator-3395767.okta.com/oauth2/default"
            - name: WEB_OPTION_ACCOUNT_EDIT_LINK_HREF
              value: "https://integrator-3395767.okta.com/oauth2/default/v1/userinfo"
            - name: PROXY_OIDC_REWRITE_WELLKNOWN
              value: "true"
            - name: WEB_OIDC_CLIENT_ID
              value: "0oau1w8hyrE07CNO8697"
            - name: PROXY_USER_OIDC_CLAIM
              value: "preferred_username"
            - name: PROXY_USER_CS3_CLAIM
              value: "username"
            - name: OC_ADMIN_USER_ID
              value: ""
            - name: GRAPH_ASSIGN_DEFAULT_USER_ROLE
              value: "false"
            - name: GRAPH_USERNAME_MATCH
              value: "none"
            - name: PROXY_ROLE_ASSIGNMENT_OIDC_CLAIM
              value: "roles"
            - name: PROXY_OIDC_ACCESS_TOKEN_VERIFY_METHOD
              value: "jwt"
            - name: WEB_OIDC_METADATA_URL
              value: "https://integrator-3395767.okta.com/oauth2/default/.well-known/openid-configuration"
            - name: WEB_OIDC_SCOPE
              value: "openid profile email groups roles"
            # Admin user password
            - name: IDM_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name:
                          release-name-opencloud-opencloud
                  key: adminPassword
            # Demo users
            - name: IDM_CREATE_DEMO_USERS
              value: "false"
            - name: MICRO_REGISTRY_ADDRESS
              value: "127.0.0.1:9233"
            # Make the registry available to the app provider containers
            - name: NATS_NATS_HOST
              value: "0.0.0.0"
            - name: NATS_NATS_PORT
              value: "9233"
            # CSP configuration
            - name: PROXY_CSP_CONFIG_FILE_LOCATION
              value: "/etc/opencloud/csp.yaml"
            # Storage configuration
            # Always use decomposeds3 for user storage and decomposed for system storage
            - name: STORAGE_USERS_DRIVER
              value: "decomposeds3"
            - name: STORAGE_SYSTEM_DRIVER
              value: "decomposed"
            
            # S3 storage configuration
            # External S3 storage
            - name: STORAGE_USERS_DECOMPOSEDS3_ENDPOINT
              value: "https://truenas.mcintosh.farm:9000"
            - name: STORAGE_USERS_DECOMPOSEDS3_REGION
              value: "default"
            - name: STORAGE_USERS_DECOMPOSEDS3_BUCKET
              value: "opencloud"
            - name: STORAGE_USERS_DECOMPOSEDS3_CREATE_BUCKET
              value: "true"
            - name: STORAGE_USERS_DECOMPOSEDS3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: opencloudcredentials
                  key: accessKey
            - name: STORAGE_USERS_DECOMPOSEDS3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: opencloudcredentials
                  key: secretKey
          ports:
            - name: http
              containerPort: 9200
            - name: nats
              containerPort: 9233
          startupProbe:
            httpGet:
              path: /health
              port: 9200
            periodSeconds: 2
            timeoutSeconds: 5
            failureThreshold: 60
          livenessProbe:
            httpGet:
              path: /health
              port: 9200
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 9200
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: config
              mountPath: /etc/opencloud
            - name: data
              mountPath: /var/lib/opencloud
            - name: config-json
              mountPath: /var/lib/opencloud/config.json
              subPath: config.json
            - name: config-files
              mountPath: /etc/opencloud/search.yaml
              subPath: search.yaml
            - name: config-files
              mountPath: /etc/opencloud/csp.yaml
              subPath: csp.yaml
            - name: config-files
              mountPath: /etc/opencloud/banned-password-list.txt
              subPath: banned-password-list.txt
          resources:
            limits:
              memory: 20Gi
            requests:
              cpu: 128m
              memory: 128Mi
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: release-name-opencloud-opencloud-config
        - name: data
          persistentVolumeClaim:
            claimName: release-name-opencloud-opencloud-data
        - name: config-json
          configMap:
            name: release-name-opencloud-opencloud-config-json
        - name: config-files
          configMap:
            name: release-name-opencloud-opencloud-config
        - name: proxy-config
          configMap:
            name: release-name-opencloud-opencloud-proxy-config
        
        - name: extensions
          emptyDir: {}
        - name: web-extensions-init-script
          configMap:
            name: release-name-opencloud-opencloud-web-extensions-init
---
# Source: opencloud/templates/tika/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: release-name-opencloud-tika
  labels:
    helm.sh/chart: opencloud-0.2.3
    app.kubernetes.io/name: opencloud
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "latest"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: tika
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: opencloud
      app.kubernetes.io/instance: release-name
      app.kubernetes.io/component: tika
  template:
    metadata:
      labels:
        app.kubernetes.io/name: opencloud
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/component: tika
    spec:
      containers:
        - name: tika
          image: "docker.io/apache/tika:2.9.2.1-full"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 9998
              protocol: TCP
          env:
            - name: JAVA_OPTS
              value: "-Xmx3g"
          resources:
            limits:
              cpu: 1000m
              memory: 3Gi
            requests:
              cpu: 100m
              memory: 1Gi
---
# Source: opencloud/templates/opencloud/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: release-name-opencloud-opencloud
  annotations:
    cert-manager.io/cluster-issuer: cloudflare-issuer
spec:
  ingressClassName: "nginx"
  tls:
    - hosts:
        - "opencloud.mcintosh.farm"
      secretName: opencloud-tls-secret
  rules:
    - host: "opencloud.mcintosh.farm"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: release-name-opencloud-opencloud
                port:
                  number: 9200
